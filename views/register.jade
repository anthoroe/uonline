extends layout
block title
	Регистрация
block content
	.page-header
		h1 Регистрация
	if error === true
		.alert.alert-danger
			a.close(href='#', data-dismiss='alert') &times;
			if loginIsBusy === true
				b Извините! Это имя уже занято.
				| #{' '}Придумайте какое-нибудь другое.
			else
				b Ой! Во введённых данных что-то не так.
				| #{' '}Исправьте ошибки и попробуйте ещё раз.
	form.form-horizontal(method='post', action='/register/')
		#user-form-group.form-group(class=((invalidLogin || loginIsBusy)?'has-error':''))
			label.col-sm-2.control-label(for='user') Логин
			.col-sm-3
				input.form-control#user(type='text', name='user', maxlength='32', value=user, required, autofocus)
			span.col-sm-7.help-block
				small От 2 до 32 символов, [a-zA-Z0-9а-яА-Я_- ].
		#password-form-group.form-group(class=(invalidPass?'has-error':''))
			label.col-sm-2.control-label(for='pass') Пароль
			.col-sm-3
				.input-group
					input.form-control#pass(type='password', name='pass', maxlength='32', value=pass, required)
					a#revealpass.btn.btn-default.input-group-addon(title='Показать пароль')
						i.glyphicon.glyphicon-eye-open
			span.col-sm-7.help-block
				small #{' '}От 4 до 32 символов, [a-zA-Z0-9!@#$%^&amp;*()_+]
		.form-group
			.col-sm-2
			.col-sm-3
				button.btn.btn-default(type='submit') Зарегистрироваться
	script(src='/static/browserified/validation.min.js')
	:coffee
		# Common variables
		usernameField = $('input[name=user]')
		usernameFormGroup = $('#user-form-group')
		passwordField = $('input[name=pass]')
		passwordFormGroup = $('#password-form-group')
		revealPasswordButton = $('#revealpass')

		# Reveal password
		revealPasswordButton.click ->
			passwordField.prop 'type', (if passwordField.prop('type') is 'password' then 'text' else 'password')
			revealPasswordButton.toggleClass 'active'

		# Validate password
		passwordField.change ->
			if validation.passwordIsValid(passwordField.val())
				passwordFormGroup.removeClass 'has-error'
			else
				passwordFormGroup.addClass 'has-error'

		# Validate username
		usernameField.change ->
			usernameFormGroup.removeClass 'has-error'
			if validation.usernameIsValid(usernameField.val())
				$.getJSON "/ajax/isNickBusy/#{encodeURIComponent(usernameField.val())}", (data) ->
					if data.isNickBusy and data.nick == usernameField.val()
						usernameFormGroup.addClass 'has-error'
			else
				usernameFormGroup.addClass 'has-error'
